apiVersion: batch/v1
kind: Job
metadata:
  name: vault-init
  namespace: vault
  annotations:
    argocd.argoproj.io/sync-wave: "2"
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: vault-init
          image: hashicorp/vault:1.15
          env:
            - name: VAULT_ADDR
              value: "http://vault.vault.svc.cluster.local:8200"
            - name: VAULT_TOKEN
              value: "root-token-dev"
          command:
            - /bin/sh
            - -c
            - |
              set -e
              echo "Waiting for Vault to be ready..."
              until vault status 2>/dev/null; do
                echo "Vault is not ready yet..."
                sleep 2
              done

              echo "Enabling KV secrets engine v2..."
              vault secrets enable -path=secret -version=2 kv 2>/dev/null || echo "KV engine already enabled"

              echo "Creating PostgreSQL secrets..."
              vault kv put secret/postgresql \
                POSTGRES_USER=accounting \
                POSTGRES_PASSWORD=accounting-secure-password \
                POSTGRES_DB=accounting \
                POSTGRES_HOST=postgresql.default.svc.cluster.local \
                POSTGRES_PORT=5432

              echo "Verifying secrets..."
              vault kv get secret/postgresql

              echo "Vault initialization complete!"
